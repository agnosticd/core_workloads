apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: {{ ocp4_workload_authentication_keycloak_default_realm }}
spec:
  keycloakCRName: keycloak
  realm:
    id: {{ ocp4_workload_authentication_keycloak_default_realm }}
    realm: {{ ocp4_workload_authentication_keycloak_default_realm }}
    enabled: true
    sslRequired: external
    registrationAllowed: true
    loginWithEmailAllowed: true
    duplicateEmailsAllowed: false
    clients:
      - clientId: {{ ocp4_workload_authentication_keycloak_openshift_client_id }}
        enabled: true
        clientAuthenticatorType: client-secret
        secret: {{ _ocp4_workload_authentication_keycloak_openshift_client_secret }}
        publicClient: false
        redirectUris:
        - "*"
        standardFlowEnabled: true
        directAccessGrantsEnabled: true
        serviceAccountsEnabled: true
        frontchannelLogout: false
        protocol: openid-connect
    roles:
      realm:
        - name: user
          description: "Default user role"
        - name: admin
          description: "Administrator role"
{% if _ocp4_workload_authentication_keycloak_num_users > 0 or _ocp4_workload_authentication_keycloak_named_users | length > 0 %}
    users:
{% for _user in _ocp4_workload_authentication_keycloak_named_users %}
      - username: {{ _user.name }}
        enabled: true
        emailVerified: true
        email: {{ _user.name }}@demo.redhat.com
        firstName: {{ _user.name | capitalize }}
        lastName: Demo
        credentials:
          - type: password
            value: {{ _ocp4_workload_authentication_keycloak_named_user_passwords[_user.name] | to_json }}
            temporary: false
        realmRoles: {{ _user.realm_roles | default(['user']) | to_json }}
{% endfor %}
{% for i in range(0, _ocp4_workload_authentication_keycloak_num_users) %}
      - username: {{ ocp4_workload_authentication_keycloak_user_username_base }}{{ i|int + 1 }}
        enabled: true
        emailVerified: true
        email: {{ ocp4_workload_authentication_keycloak_user_username_base }}{{ i|int + 1 }}@demo.redhat.com
        firstName: {{ ocp4_workload_authentication_keycloak_user_username_base | capitalize }}{{ i|int + 1 }}
        lastName: Demo
        credentials:
          - type: password
            value: {{ _ocp4_workload_authentication_keycloak_named_user_passwords[i] | to_json }}
            temporary: false
        realmRoles:
          - user
{% endfor %}
{% else %}
    users: []
{% endif %}
    groups:
      - name: admins
      - name: users

